{% load pagination_tags %}
<form method="get" hx-get="" hx-target="#tabla-assignments-general" hx-swap="innerHTML" class="flex flex-wrap gap-4 mb-4">
    <input type="text" name="programa" value="{{ request.GET.programa }}" placeholder="Buscar por programa" class="input input-bordered w-full max-w-xs" />
    <input type="text" name="agente" value="{{ request.GET.agente }}" placeholder="Buscar por agente" class="input input-bordered w-full max-w-xs" />
    <input type="text" name="deudor" value="{{ request.GET.deudor }}" placeholder="Buscar por deudor" class="input input-bordered w-full max-w-xs" />
    <button type="submit" class="btn btn-primary">Filtrar</button>
</form>
<table class="custom-table" id="tabla-assignments-general">
    <thead>
        <tr>
            <th>ID</th>
            <th>Programa</th>
            <th>Agente</th>
            <th>Deudor</th>
            <th>Fecha de asignación</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for assignment in assignments %}
        <tr>
            <td>{{ assignment.id }}</td>
            <td>{{ assignment.program.title }}</td>
            <td>{{ assignment.agent.get_full_name|default:assignment.agent.username }}</td>
            <td>{{ assignment.debtor.name }}</td>
            <td>{{ assignment.created_at|date:'Y-m-d H:i' }}</td>
            <td>
                <button class="btn btn-xs btn-warning" hx-get="{% url 'assignment-edit' assignment.id %}" hx-target="#modal-edit-assignment-form-content" hx-swap="innerHTML" hx-trigger="click" onclick="edit_assignment_modal.showModal()">Editar</button>
                <a href="{% url 'management-list' assignment.id %}" class="btn btn-xs btn-info">Management</a>
                <button class="btn btn-xs btn-error" onclick="openDeleteAssignmentModal('{{ assignment.id }}', true)">Eliminar</button>
            </td>
        </tr>
        {% empty %}
            <tr>
                <td colspan="12" style="text-align: center|;">No hay asignaciones registradas.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% if is_paginated %}
    {% smart_pagination page_obj "#tabla-assignments-general" %}
{% endif %}

<script>
function openDeleteAssignmentModal(id, isGeneral) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: 'Esta acción no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/management/assignments/delete/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(resp => {
                if (resp.status === 204) {
                    Swal.fire('¡Eliminado!', 'La asignación ha sido eliminada.', 'success');
                    htmx.ajax('GET', '/management/assignments/', {target: '#tabla-assignments-general', swap: 'innerHTML'});
                } else {
                    Swal.fire('Error', 'No se pudo eliminar la asignación.', 'error');
                }
            });
        }
    });
}
</script>
